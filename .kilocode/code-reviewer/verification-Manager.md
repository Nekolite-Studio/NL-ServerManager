# 「Manager」コンポーネント改善計画の検証 (Verification)

このドキュメントは、[`remediation-plan.md`](./remediation-plan.md:0)で提案された解決策のうち、「Manager」コンポーネントに関連するものの正確性と安全性を検証し、フィードバックを提供します。

---

## 検証サマリー

全体として、提案されている修正案は Manager コンポーネントの**一貫性、責務分離、堅牢性**を大幅に向上させるものであり、すべて的確かつ実行価値が高いと判断します。特に、巨大なレンダラープロセスの分割 (2.1) と、設定ファイルの破壊的なクリア処理の修正 (3.1) は、アプリケーションの保守性と信頼性を確保する上で極めて重要です。

各提案は「機能第一」の原則に沿っており、コードベースの健全化を通じて将来の機能開発を加速させるための確かな土台となります。

---

## 各修正案の詳細レビュー

### 1. APIと応答形式の統一 (1.1, 1.3)

- **提案**:
    - WebSocket/IPCの命名規則を `kebab-case` に統一する。
    - すべての非同期応答を `{ success, payload/error }` 形式のラッパーで統一する。
- **検証結果**:
    - **正確性**: ○ 提案はAPI設計のベストプラクティスに沿っています。一貫した命名規則と応答形式は、APIの予測可能性を高め、クライアント側のエラーハンドリングを劇的に簡素化します。
    - **安全性**: ○ 変更自体に危険性はありませんが、影響範囲が広いため、Manager-Agent間、Main-Renderer間のすべての通信箇所で修正漏れがないか慎重な確認が必要です。修正が不完全な場合、通信エラーやUIの誤動作に繋がります。
- **推奨事項**:
    - 影響を受ける全てのメッセージタイプとIPCチャネルをリストアップし、修正作業のチェックリストとして活用することを推奨します。
    - この統一ラッパーの導入は、後述するプロトコルの明示的な定義 (4.1) と合わせて行うと、より効果的です。

### 2. ネットワークライブラリの統一 (1.2)

- **提案**: HTTPリクエストを `axios` に統一する。
- **検証結果**:
    - **正確性**: ○ `net`モジュールによる手動実装から `axios` へ移行する案は、コードの簡潔化、依存関係の削減、エラーハンドリングの標準化に繋がり、完全に妥当です。`ws` を維持する判断も適切です。
    - **安全性**: ○ `axios` への置き換えは安全なリファクタリングです。ただし、既存の `net` モジュール実装に特有のロジック（カスタムヘッダー、特殊なタイムアウト処理など）が存在しないか確認し、設定を正しく移行する必要があります。
- **推奨事項**:
    - `axios` のインスタンスを生成し、ベースURLや共通のタイムアウト設定を適用することで、コードの重複をさらに削減できます。

### 3. レンダラープロセスの責務分離 (2.1)

- **提案**: [`renderer.js`](./manager/renderer.js:0) を `renderer-ui.js` と `renderer-state.js` に分割する。
- **検証結果**:
    - **正確性**: ◎ 単一責任の原則に則った、模範的なリファクタリング案です。UI描画、状態管理、イベントハンドリングの関心を分離することで、各モジュールの見通しが良くなり、テストも容易になります。
    - **安全性**: △ ロジックの移動とファイル分割は、意図しない挙動の変化を引き起こすリスクが伴います。特に、複数のUIコンポーネントから参照される共有状態の管理は、整合性が崩れないよう細心の注意を払う必要があります。
- **推奨事項**:
    - まず状態管理ロジック (`renderer-state.js`) を分離・確立し、次にUIモジュールがその状態を参照・更新するように段階的にリファクタリングを進めることを推奨します。
    - 分割後のモジュール間のインターフェース（どの関数が公開されるか）を明確に定義することが重要です。

### 4. 汎用IPCチャネルの廃止 (2.2)

- **提案**: `sendJsonMessage` を廃止し、`proxyToServer` に統合する。
- **検証結果**:
    - **正確性**: ○ 責務が曖昧な `sendJsonMessage` を廃止し、より意図の明確な `proxyToServer` に統一するのは、APIサーフェスをクリーンに保つ上で正しいアプローチです。
    - **安全性**: ◎ 影響範囲が `update_properties` の呼び出し箇所に限定されているため、リスクは非常に低く、安全な改善と言えます。
- **推奨事項**:
    - この修正は即座に適用可能です。

### 5. 設定ファイルの破壊的なクリア処理の修正 (3.1)

- **提案**: `store.clear()` を中止し、設定ファイルのバックアップとユーザーへの確認ダイアログを導入する。
- **検証結果**:
    - **正確性**: ◎ ユーザーデータを予告なく破壊する現在の実装は致命的な欠陥です。提案されたバックアップと確認のフローは、データ損失を防ぐための必須の修正です。
    - **安全性**: ◎ この修正はアプリケーションの信頼性と安全性を劇的に向上させます。
- **推奨事項**:
    - **最優先で対応すべきタスク**として位置づけることを強く推奨します。
    - ユーザーが確認ダイアログで「いいえ」を選択した場合の挙動（例: アプリケーションを終了する）も明確に定義しておくべきです。

### 6. 暗黙的な通信プロトコルの改善 (4.1)

- **提案**: `PROTOCOL.md` の作成、メッセージタイプの定数化、スキーマ検証の導入。
- **検証結果**:
    - **正確性**: ◎ ManagerとAgent間の「契約」を明文化する極めて重要な提案です。暗黙知を形式知にすることで、開発者間の認識齟齬を防ぎ、メンテナンス性を飛躍的に向上させます。
    - **安全性**: ○ 文書化と定数化は完全に安全です。スキーマ検証ライブラリ (`zod`など) の導入は、実行時オーバーヘッドが僅かにありますが、プロトコル違反を早期に検知できるメリットがはるかに上回ります。
- **推奨事項**:
    - まずはメッセージタイプを定数化し、ManagerとAgentの両プロジェクトから参照できる共有ファイルに配置することから着手するのが効果的です。
    - `PROTOCOL.md` には、メッセージ `type` ごとに `payload` の構造、各フィールドの説明、期待される応答形式（成功/失敗時）を具体例と共に記述することが望ましいです。