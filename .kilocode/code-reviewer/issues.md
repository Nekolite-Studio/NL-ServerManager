# コード品質レビュー指摘事項

このドキュメントは、Server Managerコードベースの潜在的な品質問題点をまとめたものです。

## 1. プロトコル定義の一貫性の欠如 (マジックストリングの使用)

**重要度:** 高

**問題:** `manager`と`agent`間の通信において、[`common/protocol.js`](./common/protocol.js:6)で定義されたメッセージ定数を使わず、ハードコードされた文字列（マジックストリング）が使用されている箇所が複数存在します。これにより、プロトコル仕様の変更時に追跡が困難になり、バグの温床となります。

**該当箇所:**

- **ファイル:** [`manager/main.js`](./manager/main.js:109) (L109-135)
  - **説明:** `ws.on('message', ...)`内の`switch`文で、`Message.SERVER_LIST_UPDATE`などの定数を使用せず、`'server-list-update'`のような文字列リテラルで比較しています。
  - **コード (例):**
    ```javascript
// 修正前
switch(type) {
    case Message.SERVER_LIST_UPDATE: // 正しいが、他のcaseが文字列
        // ...
    case 'progress-update': // 修正が必要
        // ...
}
    ```

- **ファイル:** [`agent/index.js`](./agent/index.js:138) (L138)
  - **説明:** Managerからのメッセージを処理する`switch`文で、`Message.GET_METRICS`を使用せず、`'get-metrics'`という文字列が使用されています。
  - **コード (例):**
    ```javascript
// 修正前
switch (type) {
  case 'get-metrics': // Message.GET_METRICS を使うべき
    ws.send(JSON.stringify({ type: 'metrics-data', payload: getMetrics() }));
    break;
}
    ```

**推奨される修正:**
全てのメッセージタイプ比較を[`common/protocol.js`](./common/protocol.js:6)の`Message`オブジェクト定数を使用するように統一してください。

## 2. エラーハンドリングの不備 (UIへの通知漏れ)

**重要度:** 中

**問題:** Agent側で発生した重要なフォールバック処理やエラーが、UI（Manager側）に適切に通知されていません。これにより、ユーザーはシステムの実際の動作を誤解する可能性があります。

**該当箇所:**

- **ファイル:** [`agent/src/serverManager.js`](./agent/src/serverManager.js:442) (L442-450)
  - **説明:** `startServer`関数で、指定されたJavaバージョンが見つからずにシステムのデフォルト`java`にフォールバックする際、その事実がコンソールに警告として出力されるだけで、操作をリクエストしたユーザーには通知されません。
  - **影響:** ユーザーは、意図しないJavaバージョンでサーバーが起動していることに気づけません。

**推奨される修正:**
このような重要なフォールバックが発生した場合、`OPERATION_RESULT`または別の通知メッセージタイプを用いて、Managerに状況を通知するべきです。

## 3. データコントラクトの不備 (未実装の機能)

**重要度:** 中

**問題:** プロトコルとして定義されているにも関わらず、重要な機能がダミーデータまたは未実装のままになっています。「機能第一」の観点から、アプリケーションのコアな価値を提供する機能が欠落している状態です。

**該当箇所:**

- **ファイル:** [`agent/index.js`](./agent/index.js:47) (L47-L58)
  - **説明:** `getMetrics`関数が返すCPU、RAM、Disk使用率などのメトリクスが、全て`Math.random()`によるダミーデータとなっています。
  - **影響:** ユーザーは物理サーバーの実際の負荷を監視できず、アプリケーションの重要な機能が機能不全に陥っています。

**推奨される修正:**
`os`モジュールや`systeminformation`のようなライブラリを使用して、実際のシステムメトリクスを取得・送信するように実装してください。

## 4. 冗長なロジック (DRY原則違反)

**重要度:** 低

**問題:** UIロジックと状態管理において、類似した処理や責任が複数の箇所に分散しており、コードの重複が見られます。

**該当箇所:**

- **ファイル:** [`manager/renderer.js`](./manager/renderer.js:12) (L12, L578)
  - **説明:** 物理サーバーのメトリクスを取得するためのポーリングを開始/停止するロジック (`startGlobalMetricsLoop`, `stopGlobalMetricsLoop`)が、`updateView`関数からビューの状態に応じて呼び出されています。この依存関係は暗黙的であり、UIの描画とバックグラウンドのポーリング制御が密結合しています。
  - **影響:** 将来的にビューの種類が増えたり、ポーリングの条件が変更されたりした場合に、修正が煩雑になる可能性があります。

**推奨される修正:**
`updateView`関数は純粋にUIの表示/非表示に専念させ、ポーリングの制御はナビゲーションイベントのハンドリングなど、ビューが切り替わる根本的な原因となる場所で明示的に行うべきです。