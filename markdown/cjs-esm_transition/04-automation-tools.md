# 4. 自動化ツールの活用

プロジェクト内のすべてのファイルを一つずつ手作業でESM構文に変換するのは、非常に時間がかかり、ミスが発生しやすい作業です。幸いなことに、この変換作業の大部分は「コードモッド (Codemod)」と呼ばれるツールを使って自動化できます。

この章では、代表的なコード変換ツールである `jscodeshift` を利用して、構文変換を安全かつ効率的に行う手順を解説します。

## 4.1. jscodeshiftとは？

`jscodeshift` は、JavaScriptのコードをプログラム的に解析・変換するためのツールキットです。コードを文字列としてではなく、AST (Abstract Syntax Tree, 抽象構文木) として扱います。これにより、コードの構造を正確に理解した上で、安全に変換処理（例: `require` を `import` に変える）を実行できます。

## 4.2. セットアップ

`jscodeshift` 本体と、CJSからESMへの変換ロジックが書かれたスクリプト（`cjs-to-es6`）をインストールします。これらは開発時のみに利用するため、`devDependencies` に追加するのが一般的ですが、`npx` を使って直接実行することも可能です。ここでは `npx` を利用する手順を説明します。

特別なセットアップは不要で、`npx` コマンド経由で直接実行できます。

## 4.3. 変換の実行手順

`jscodeshift` を使った変換は、以下の2ステップで行うことを強く推奨します。

1.  **ドライラン (Dry Run):** まずは変更内容をプレビューし、意図しない変換が行われないか確認します。
2.  **本実行:** 確認後、実際にファイルに変更を適用します。

### ステップ 1: ドライランで変更内容を確認する

まず、`--dry` オプションを付けてコマンドを実行し、どのような変更が行われるかを確認します。この時点では、実際のファイルは一切変更されません。

**実行コマンド例 (`agent` パッケージの `src` ディレクトリを対象とする場合):**

```bash
npx jscodeshift -t https://raw.githubusercontent.com/gajus/commonjs-to-es6-codemod/master/transforms/commonjs.js agent/src --dry --print --extensions=js
```

-   `-t <transform>`: 適用する変換スクリプトを指定します。ここでは `commonjs-to-es6-codemod` のURLを直接指定しています。
-   `agent/src`: 変換対象のディレクトリまたはファイルを指定します。
-   `--dry`: ファイルを書き換えずに、結果をコンソールに出力します。
-   `--print`: 変換後のコードをコンソールに表示します。
-   `--extensions=js`: 変換対象とするファイルの拡張子を指定します。

コンソールに出力された差分を確認し、変換が概ね正しく行われているかを確認してください。

### ステップ 2: 実際にファイルを変換する

ドライランで問題がないことを確認したら、`--dry` オプションを外してコマンドを再実行し、ファイルに変換を適用します。

**注意:** このコマンドはファイルを直接上書きします。**実行前に必ずGitなどでバージョン管理を行い、変更をコミットまたはスタッシュしておくことを強く推奨します。**

**実行コマンド例:**

```bash
npx jscodeshift -t https://raw.githubusercontent.com/gajus/commonjs-to-es6-codemod/master/transforms/commonjs.js agent/src --print --extensions=js
```

## 4.4. その他のツール

### lebab

`lebab` も人気のあるコード変換ツールですが、ES6+の様々な構文への変換を目的としており、CJSからESMへの変換に特化しているわけではありません。より多機能ですが、今回の目的では `jscodeshift` と `cjs-to-es6-codemod` の組み合わせがシンプルで強力です。

## 4.5. 自動化の限界と手動修正

コードモッドは非常に強力ですが、万能ではありません。自動変換後には、必ず手動での確認と修正が必要です。

特に、以下の点はツールが正しく変換できない、または対応していない場合があります。

-   **動的な `require`:** `require(variable)` のような変数を引数に取る `require` は変換されません。これらは手動で `await import()` に書き換える必要があります。
-   **`__dirname` / `__filename`:** これらは `import.meta.url` を使った形には自動変換されません。手動での修正が必要です。
-   **JSONファイルのインポート:** JSONファイルの `require` は、`fs` を使った読み込みなどに手動で修正する必要があります。
-   **コードのフォーマット:** 変換によってインデントや改行が崩れることがあります。変換後に `Prettier` などのフォーマッターを実行することを推奨します。

**自動変換はあくまで移行作業の第一歩です。** 変換後は必ずリンターやテストを実行し、アプリケーションが正しく動作することを確認してください。