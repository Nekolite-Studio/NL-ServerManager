# Windows環境におけるパフォーマンス改善および解凍不具合の修正

## 1. 概要

Windows環境において、Agentの動作中に以下の2つの深刻な問題が発生していました。

1.  **CPU使用率の張り付き:** Javaダウンロード中などにPowerShellプロセスが大量に起動し、CPU使用率が100%になる。
2.  **解凍処理の停止:** ファイルダウンロード後の解凍フェーズが0%で停止し、完了しない。

これらの問題に対処するため、メトリクス収集ロジックの抜本的な見直しと、ファイル操作処理のクロスプラットフォーム対応強化を実施しました。

## 2. 問題の原因分析

### 2.1. メトリクス収集による高負荷
`systeminformation` ライブラリは、Windows環境において `si.processes()` などの呼び出し時にバックグラウンドでPowerShellやWMICコマンドを実行します。Agentはこれを1秒間隔で呼び出していましたが、システム負荷が高い（ダウンロード中など）場合、コマンドの実行完了に1秒以上かかることがあり、未完了のプロセスが積み重なることでCPUリソースを枯渇させていました。また、これがNode.jsのイベントループをブロックし、他の非同期処理（ストリーム処理など）を阻害していました。

### 2.2. Zip解凍処理の不具合
`unzipper` ライブラリを使用した解凍ロジックにおいて、以下の実装ミスがありました。
* **パス区切り文字の誤り:** Zip内のパスは `/` 区切りですが、Windows環境で `path.sep` (`\`) を使用して解析しようとしたため、ディレクトリ構造を正しく認識できていませんでした。
* **ストリームの詰まり:** 処理対象外と判定したファイルエントリに対して `entry.autodrain()` を呼び出さずにリターンしていたため、Zipストリームの読み込みがそこで停止していました。

## 3. 実施した修正内容

### 3.1. メトリクス収集の軽量化と最適化
* **ライブラリの変更:** 重たい `systeminformation.processes()` を廃止し、以下の軽量な手段に切り替えました。
    * **CPU/メモリ全体:** Node.js標準の `os` モジュールを使用して計算。
    * **個別プロセス:** `pidusage` ライブラリを導入し、監視対象のPIDのみをピンポイントで計測。
* **排他制御の導入:** `setInterval` によるループ内にフラグによるロック機構を追加し、前回の収集処理が終わるまで次を実行しないようにしました。

### 3.2. ファイル展開ロジックの修正 (`fileService.js`)
* **パス解析の修正:** Zipエントリのパス分割に `path.sep` ではなく明示的に `'/'` を使用するように変更しました。
* **ストリーム制御の改善:** 不要なファイルエントリ（ルートディレクトリ直下のファイルなど）をスキップする場合でも、必ず `entry.autodrain()` を呼び出し、ストリームを継続させるように修正しました。

## 4. 結果

* Windows環境においてもCPU使用率が大幅に低下し、安定した動作を確認しました。
* Javaのダウンロードおよび解凍処理が、Linux環境と同等の速度で正常に完了するようになりました。
* メトリクスの更新頻度（1秒間隔）を維持しつつ、システムへの負荷を最小限に抑えることに成功しました。
