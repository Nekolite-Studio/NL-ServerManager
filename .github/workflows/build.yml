name: Build and Release

on:
  push:
    branches: [ "main", "develop" ]
  release:
    types: [ published ]
  workflow_dispatch:

jobs:
  # ========================================================
  # Job 0: Prepare Matrix (どのOSでビルドするか決定)
  # ========================================================
  prepare-matrix:
    runs-on: ubuntu-latest
    outputs:
      os_matrix: ${{ steps.set-matrix.outputs.os_matrix }}
    steps:
      - id: set-matrix
        shell: bash
        run: |
          if [ "${{ github.event_name }}" == "release" ]; then
            echo 'os_matrix=["ubuntu-latest", "windows-latest", "macos-latest"]' >> $GITHUB_OUTPUT
          else
            echo 'os_matrix=["windows-latest"]' >> $GITHUB_OUTPUT
          fi

  # ========================================================
  # Job 1: Build Agent (Node.js binary)
  # ========================================================
  build-agent:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm'

      - name: Install Root Dependencies
        run: npm run install:root
      - name: Install All Dependencies
        run: npm run install:all

      # --- Artifacts Build (Windows Only) ---
      - name: Build Agent (Artifacts/Windows)
        if: github.event_name != 'release'
        run: npm run build:agent:win

      # --- Release Build (All Platforms) ---
      - name: Build Agent (Release/All)
        if: github.event_name == 'release'
        run: npm run build:agent

      - name: Upload Agent Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: agent-binaries
          path: releases/agent/*
          if-no-files-found: warn

  # ========================================================
  # Job 2: Build Manager (Electron App)
  # ========================================================
  build-manager:
    needs: prepare-matrix
    name: Build Manager (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: ${{ fromJson(needs.prepare-matrix.outputs.os_matrix) }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm'

      - name: Install Root Dependencies
        run: npm run install:root
      - name: Install All Dependencies
        run: npm run install:all

      # ========================================================
      # Push時のフロー (Windowsのみ)
      # ========================================================
      - name: Build Manager for Artifacts (Windows)
        if: github.event_name != 'release' && matrix.os == 'windows-latest'
        run: npm run ci:artifact:win
        working-directory: manager

      # ========================================================
      # Release時のフロー (全OS)
      # ========================================================
      - name: Build Manager for Release (Linux)
        if: github.event_name == 'release' && matrix.os == 'ubuntu-latest'
        run: npm run ci:release:linux
        working-directory: manager

      - name: Build Manager for Release (Windows)
        if: github.event_name == 'release' && matrix.os == 'windows-latest'
        run: npm run ci:release:win
        working-directory: manager

      - name: Build Manager for Release (macOS)
        if: github.event_name == 'release' && matrix.os == 'macos-latest'
        run: npm run ci:release:mac
        working-directory: manager

      # ========================================================
      # Upload Artifacts
      # ========================================================
      - name: Upload Manager Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: manager-${{ matrix.os }}
          path: releases/manager/*
          if-no-files-found: ignore

  # ========================================================
  # Job 3: Create GitHub Release
  # ========================================================
  upload-release-assets:
    needs: [build-agent, build-manager]
    runs-on: ubuntu-latest
    if: github.event_name == 'release'
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: assets

      - name: Display structure
        run: ls -R assets

      - name: Upload Release Assets
        uses: softprops/action-gh-release@v1
        with:
          files: |
            assets/agent-binaries/*
            assets/manager-ubuntu-latest/*.AppImage
            assets/manager-ubuntu-latest/*.deb
            assets/manager-windows-latest/*.exe
            assets/manager-macos-latest/*.dmg
            assets/manager-macos-latest/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ========================================================
  # (Commented Out) NPM Publish Job
  # ========================================================
  # publish-npm:
  #   needs: [build-agent, build-manager]
  #   runs-on: ubuntu-latest
  #   if: github.event_name == 'release'
  #   steps:
  #     - uses: actions/checkout@v4
  #     - uses: actions/setup-node@v4
  #       with:
  #         node-version: 18
  #         registry-url: 'https://registry.npmjs.org'
  #     - run: npm ci
  #     - run: npm publish -w common
  #       env:
  #         NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
  #     - run: npm publish -w agent
  #       env:
  #         NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
  #     # Manager is usually not published to NPM, but if needed:
  #     # - run: npm publish -w manager
  #     #   env:
  #     #     NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  # ========================================================
  # (Commented Out) Alternative Build Methods
  # ========================================================
  # # Example: Using Docker for consistent Linux builds
  # build-linux-docker:
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: actions/checkout@v4
  #     - name: Build in Docker
  #       uses: docker://electronuserland/builder:wine
  #       with:
  #         args: /bin/bash -c "npm ci && npm run build:linux -w manager"